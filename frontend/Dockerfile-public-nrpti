# Base image for the container
FROM node:18.19-alpine

# Set the working directory
WORKDIR /app/

# Copy package.json and package-lock.json first to leverage Docker cache
COPY package*.json ./

# Install dependencies with maximum verbosity
RUN npm install

# Copy the rest of the application code
COPY . /app

# Make sure the services directory structure exists
RUN mkdir -p /app/projects/global/src/lib/services

# List the contents of the source directory to debug
RUN ls -la /app/projects/global/src/lib/

# Build the library with verbose logging and ensure it completes
RUN npm run build:library && \
    ls -la dist/nrpti-angular-components && \
    cd dist/nrpti-angular-components && \
    npm link && \
    cd /app && \
    npm link nrpti-angular-components && \
    npm run build:app:public-nrced

# Install a simple server to serve static files
RUN npm install -g serve

# Make entrypoint script for public-nrpti
COPY entrypoint-public-nrpti.sh /app/entrypoint-public-nrpti.sh
RUN chmod +x /app/entrypoint-public-nrpti.sh

# Expose port 80
EXPOSE 4300

# Use the entrypoint script
CMD ["/app/entrypoint-public-nrpti.sh"] 